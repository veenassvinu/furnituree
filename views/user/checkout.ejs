<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Furniture Store</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/checkout.css">
</head>

<%- include("../../views/partials/user/header.ejs") %>

    <body>
        <%- include("../../views/partials/user/navBar.ejs") %>

            <!-- Main Checkout Content -->
            <div class="checkout-container">
                <h1 class="checkout-title">Checkout</h1>

                <div class="checkout-content">
                    <!-- Billing Details -->
                    <div class="billing-section">
                        <h2 class="section-title">Billing Details</h2>

                        <form id="addressForm" method="post" action="/save-address">
                            <div class="form-group">
                                <label for="addressType">Address Type</label>
                                <select id="addressType" name="addressType" class="form-control" required>
                                    <option value="">Select Type</option>
                                    <option value="home">üè† Home</option>
                                    <option value="work">üè¢ Work</option>
                                    <option value="other">üìç Other</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="fullName">Name</label>
                                <input type="text" id="fullName" name="name" class="form-control"
                                    placeholder="Enter name" value="<%= user ? user.name : '' %>" required>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                    <input type="tel" id="phone" name="phone" class="form-control"
                                        placeholder="Enter phone number" value="<%= user ? user.phone : '' %>" required>
                                </div>
                                <div class="form-group">
                                    <label for="email">Email Address</label>
                                    <input type="email" id="email" name="email" class="form-control"
                                        placeholder="Enter email address" value="<%= user ? user.email : '' %>">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="streetAddress">Landmark</label>
                                <textarea id="streetAddress" name="landMark" class="form-control"
                                    placeholder="Enter landmark"></textarea>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="city">City</label>
                                    <input type="text" id="city" name="city" class="form-control"
                                        placeholder="Enter city">
                                </div>
                                <div class="form-group">
                                    <label for="state">State</label>
                                    <input type="text" id="state" name="state" class="form-control"
                                        placeholder="Enter state">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="zipCode">Pincode</label>
                                    <input type="text" id="PinCode" name="pincode" class="form-control"
                                        placeholder="Enter pincode">
                                </div>
                                <div class="form-group">
                                    <label for="country">Country</label>
                                    <input type="text" id="country" name="country" class="form-control"
                                        placeholder="Enter country">
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    üíæ Save Address
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Order Summary -->
                    <div class="order-section">
                        <h2 class="section-title">Your Order</h2>

                        <div id="orderItems">
                            <% if(cartItems && cartItems.length> 0) { %>
                                <% cartItems.forEach(item=> { %>
                                    <div class="order-item">
                                        <div class="item-details">
                                            <div class="item-name">
                                                <%= item.name %>
                                            </div>
                                            <div class="item-qty">Qty: <%= item.quantity %>
                                            </div>
                                        </div>
                                        <div class="item-price">‚Çπ<%= (item.price * item.quantity).toFixed(2) %>
                                        </div>
                                    </div>
                                    <% }) %>
                                        <% } else { %>
                                            <p>Your cart is empty.</p>
                                            <% } %>
                        </div>

                        <div class="order-total">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="subtotal">‚Çπ<%= subtotal.toFixed(2) %></span>
                            </div>
                            <div class="total-row">
                                <span>Shipping:</span>
                                <span id="shipping">Free</span>
                            </div>
                            <div class="total-row">
                                <span>Discount:</span>
                                <span id="discount">‚Çπ<%= discount.toFixed(2) %></span>
                            </div>
                            <div class="total-row final">
                                <span>Grand Total:</span>
                                <span id="grandTotal">‚Çπ<%= grandTotal.toFixed(2) %></span>
                            </div>
                        </div>



                        <div class="payment-methods">
                            <h3>Payment Methods</h3>

                            <div class="payment-method selected" data-method="cod">
                                <input type="radio" name="paymentMethod" value="COD" checked>
                                <span>Cash on Delivery</span>
                            </div>

                            <div class="payment-method" data-method="card">
                                <input type="radio" name="paymentMethod" value="Card">
                                <span>Credit / Debit Card</span>
                            </div>

                            <div class="payment-method" data-method="razorpay">
                                <input type="radio" name="paymentMethod" value="Razorpay">
                                <span>Pay with Razorpay</span>
                            </div>
                        </div>

                        <button type="button" class="place-order-btn" id="placeOrderBtn">
                            Place Order
                        </button>
                    </div>
                </div>

                <!-- Saved Addresses -->
                <h2>Select Shipping Address</h2>

                <% if (addresses && addresses.length> 0) { %>
                    <% addresses.forEach((addr, index)=> { %>
                        <div class="address-box">
                            <label for="addr-<%= index %>">
                                <input type="radio" name="selectedAddress" value="<%= index %>" id="addr-<%= index %>"
                                    <%=index===0 ? "checked" : "" %>>
                                <strong>
                                    <%= addr.addressType %>
                                </strong><br>
                                <%= addr.name %> | <%= addr.phone %><br>
                                        <%= addr.landMark %>, <%= addr.city %>, <%= addr.state %> - <%= addr.pincode %>,
                                                        <%= addr.country %>
                            </label>
                        </div>
                        <% }) %>
                            <% } else { %>
                                <p>No saved addresses found. Please add an address.</p>
                                <% } %>




                                    <!-- Cart Items -->

            </div>

            <!-- Footer -->
            <%- include("../../views/partials/user/footer.ejs") %>




                <!-- ‚úÖ SweetAlert2 -->
                <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

                <script>

                    document.getElementById("addressForm").addEventListener("submit", async (e) => {
                        e.preventDefault();

                        const form = e.target;
                        const formData = new FormData(form);
                        const plainFormData = Object.fromEntries(formData.entries()); // convert to object

                        try {
                            const response = await fetch("/save-address", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(plainFormData) // send as JSON
                            });

                            const data = await response.json();

                            if (response.ok && data.success) {
                                Swal.fire({
                                    icon: "success",
                                    title: "Address Added!",
                                    text: "Your address was saved successfully.",
                                    timer: 2000,
                                    showConfirmButton: false
                                }).then(() => {
                                    window.location.reload();
                                });
                            } else {
                                Swal.fire({
                                    icon: "error",
                                    title: "Error",
                                    text: data.message || "Failed to save address. Please try again."
                                });
                            }
                        } catch (err) {
                            console.error("Error saving address:", err);
                            Swal.fire({
                                icon: "error",
                                title: "Something went wrong",
                                text: "Please try again later."
                            });
                        }
                    });


                    document.getElementById("placeOrderBtn").addEventListener("click", async () => {
                        const selectedAddressEl = document.querySelector("input[name='selectedAddress']:checked");
                        if (!selectedAddressEl) {
                            Swal.fire("No Address Selected", "Please select an address.", "warning");
                            return;
                        }
                        const selectedAddressIndex = selectedAddressEl.value;

                        const paymentMethod = document.querySelector("input[name='paymentMethod']:checked")?.value;
                        if (!paymentMethod) {
                            Swal.fire("No Payment Method", "Please select a payment method.", "warning");
                            return;
                        }

                        if (paymentMethod === "COD" || paymentMethod === "Card") {
                            // Normal order placement
                            try {
                                const response = await fetch("/place-order", {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify({ selectedAddressIndex, paymentMethod })
                                });
                                const data = await response.json();

                                if (response.ok) {
                                    Swal.fire("Order Placed", "Your order has been placed successfully!", "success")
                                        .then(() => window.location.href = "/orders");
                                } else {
                                    Swal.fire("Error", data.message || "Order failed!", "error");
                                }
                            } catch (err) {
                                Swal.fire("Error", "Something went wrong!", "error");
                            }
                        }
                        else if (paymentMethod === "Razorpay") {
                            // üîπ Call Razorpay checkout instead of placing order directly
                            startPayment(orderId, totalPrice);
                        }
                    });

                </script>

                <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

                <script>
                    async function startPayment(orderId, totalPrice) {
                        console.log("payment started", orderId, totalPrice);

                        try {
                            Swal.fire({
                                title: "Creating Order...",
                                text: "Please wait while we contact Razorpay",
                                allowOutsideClick: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                }
                            });

                            // Call backend to create Razorpay order
                            const response = await fetch("/createRazorOrder", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ orderId, totalPrice })
                            });

                            const data = await response.json();

                            if (!data.success) {
                                Swal.fire("Error", "Error creating Razorpay order", "error");
                                return;
                            }

                            Swal.close();

                            const options = {
                                key: data.key,
                                amount: data.order.amount,
                                currency: data.order.currency,
                                order_id: data.order.id,
                                name: "My Store",
                                description: "Order Payment",
                                handler: async function (response) {
                                    Swal.fire({
                                        title: "Verifying Payment...",
                                        text: "Please wait",
                                        allowOutsideClick: false,
                                        didOpen: () => {
                                            Swal.showLoading();
                                        }
                                    });

                                    const verifyRes = await fetch("/verify-payment", {
                                        method: "POST",
                                        headers: { "Content-Type": "application/json" },
                                        body: JSON.stringify({
                                            razorpay_order_id: response.razorpay_order_id,
                                            razorpay_payment_id: response.razorpay_payment_id,
                                            razorpay_signature: response.razorpay_signature,
                                            orderId: orderId
                                        })
                                    });

                                    const verifyData = await verifyRes.json();

                                    if (verifyData.success) {
                                        Swal.fire("Success", "Payment successful!", "success")
                                            .then(() => window.location.href = "/orders");
                                    } else {
                                        Swal.fire("Error", "Payment verification failed!", "error");
                                    }
                                },
                                prefill: {
                                    name: "Test User",
                                    email: "test@example.com",
                                    contact: "9999999999"
                                },
                                theme: { color: "#3399cc" }
                            };

                            const rzp1 = new Razorpay(options);
                            rzp1.open();

                        } catch (error) {
                            console.error("Payment error:", error);
                            Swal.fire("Error", "Something went wrong, please try again", "error");
                        }
                    }

                </script>

                <button onclick="startPayment('ORDabcd')">Pay Now</button>
                <button id="placeOrderBtn">Place Order</button>


    </body>

</html>