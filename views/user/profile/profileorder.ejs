<%- include("../../views/partials/user/header.ejs") %>
    <%- include("../../views/partials/user/navBar") %>

        <link rel="stylesheet" href="/css/profile.css">
        <link rel="stylesheet" href="/css/profileOrders.css">

        <div class="profile-session-container">
            <div class="container-fluid">
                <div class="dashboard">
                    <!-- Sidebar -->
                    <%- include("../../views/partials/user/profileSideBar") %>

                        <!-- Main Content -->
                        <div class="main-content">
                            <div class="content">
                                <div class="orders-header">
                                    <h2>Your Orders</h2>
                                </div>

                                <div class="orders-table-container">
                                    <table class="orders-table">
                                        <thead>
                                            <tr>
                                                <th>Order #</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                                <th>Total</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% if (orders && orders.length> 0) { %>
                                                <% orders.forEach(order=> { %>
                                                    <tr id="order-<%= order._id %>">
                                                        <td>
                                                            <span class="order-id">#<%= order.orderId ? order.orderId.toString() : 'N/A' %>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <span class="order-date">
                                                                <%= order.createdAt ? order.createdAt.toDateString() : 'N/A' %>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <!-- ✅ Fixed: Use orderStatus instead of status -->
                                                            <span
                                                                class="status-badge status-<%= order.orderStatus ? order.orderStatus.toLowerCase().replace(/\s+/g, '-') : 'unknown' %>">
                                                                <%= order.orderStatus || 'Unknown' %>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <span class="order-total">₹<%= order.totalPrice ? order.totalPrice.toFixed(2) : '0.00' %></span>
                                                        </td>
                                                        <td class="actions-cell">
                                                            <div class="action-buttons">
                                                                <a href="/orders/<%= order._id %>"
                                                                    class="btn btn-view">View</a>
                                                                <!-- ✅ Fixed: Use orderStatus instead of status -->
                                                                <% if (order.orderStatus && order.orderStatus !== 'Cancelled' && order.orderStatus !== 'Returned' && order.orderStatus !== 'Delivered') { %>
                                                                    <button class="btn btn-cancel"
                                                                        onclick="cancelOrder('<%= order._id %>', '<%= order.totalPrice || 0 %>')">Cancel</button>
                                                                <% } %>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <% }) %>
                                                        <% } else { %>
                                                            <tr>
                                                                <td colspan="5" class="no-orders">
                                                                    <div class="empty-state">
                                                                        <i class="icon-orders"></i>
                                                                        <p>No orders found</p>
                                                                        <span>Start shopping to see your orders
                                                                            here</span>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            <% } %>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination Controls -->
                                <% if (totalPages && totalPages > 1) { %>
                                    <div class="pagination-container">
                                        <nav class="pagination">
                                            <% if (hasPrevPage) { %>
                                                <a href="/profileorder?page=<%= currentPage - 1 %>"
                                                    class="page-link prev-link">
                                                    <i class="icon-arrow-left"></i>
                                                    Previous
                                                </a>
                                                <% } %>

                                                    <div class="page-numbers">
                                                        <% for (let i=1; i <=totalPages; i++) { %>
                                                            <a href="/profileorder?page=<%= i %>"
                                                                class="page-link <%= currentPage === i ? 'active' : '' %>">
                                                                <%= i %>
                                                            </a>
                                                            <% } %>
                                                    </div>

                                                    <% if (hasNextPage) { %>
                                                        <a href="/profileorder?page=<%= currentPage + 1 %>"
                                                            class="page-link next-link">
                                                            Next
                                                            <i class="icon-arrow-right"></i>
                                                        </a>
                                                        <% } %>
                                        </nav>
                                    </div>
                                    <% } %>
                            </div>
                        </div>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
            async function cancelOrder(orderId, totalPrice) {
                console.log(`Attempting to cancel order: ${orderId}`);
                try {
                    const result = await Swal.fire({
                        title: 'Are you sure?',
                        text: `Do you want to cancel this order? ₹${parseFloat(totalPrice).toFixed(2)} will be refunded to your wallet.`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, cancel it!',
                        cancelButtonText: 'No, keep it'
                    });

                    if (!result.isConfirmed) {
                        console.log('Cancellation aborted by user');
                        return;
                    }

                    Swal.fire({
                        title: 'Processing...',
                        text: 'Cancelling your order',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // ✅ Fixed: Use correct cancel route that matches your controller
                    const response = await fetch(`/cancel-order`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            orderId: orderId,
                            reason: 'Cancelled by user'
                        })
                    });

                    const data = await response.json();
                    console.log('Server response:', data);

                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Order Cancelled!',
                            text: `Order has been cancelled and ₹${parseFloat(totalPrice).toFixed(2)} has been refunded to your wallet.`,
                            timer: 3000,
                            showConfirmButton: false
                        });

                        // Update UI
                        const statusBadge = document.querySelector(`#order-${orderId} .status-badge`);
                        if (statusBadge) {
                            statusBadge.textContent = 'Cancelled';
                            statusBadge.className = 'status-badge status-cancelled';
                        }

                        const cancelButton = document.querySelector(`#order-${orderId} .btn-cancel`);
                        if (cancelButton) {
                            cancelButton.remove();
                        }
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Cancellation Failed',
                            text: data.message || 'Failed to cancel the order'
                        });
                    }
                } catch (error) {
                    console.error('Error cancelling order:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'An error occurred while cancelling the order. Please try again.'
                    });
                }
            }
        </script>